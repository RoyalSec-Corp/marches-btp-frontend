import React, { useState, useEffect } from 'react';
import authApi from '../../../services/authApi';

const ParametresEntreprise = () => {
  const [activeTab, setActiveTab] = useState('informations');
  const [loading, setLoading] = useState(true);
  const [message, setMessage] = useState('');
  const [error, setError] = useState('');
  const [entreprise, setEntreprise] = useState({ nom_entreprise: '', siret: '', adresse: '', code_postal: '', ville: '', pays: '', email: '', telephone: '', description: '', nom: '', prenom: '', fonction: '' });
  const [paiement, setPaiement] = useState({ titulaire_compte: '', nom_banque: '', iban: '', bic: '', mode_paiement: 'virement' });

  useEffect(() => { loadProfile(); }, []);

  const loadProfile = async () => { try { setLoading(true); const data = await authApi.me(); const user = data.user; setEntreprise({ nom_entreprise: user.nom_entreprise || '', siret: user.siret || '', adresse: user.adresse || '', code_postal: user.code_postal || '', ville: user.ville || '', pays: user.pays || 'France', email: user.email || '', telephone: user.telephone || '', description: user.description || '', nom: user.nom || '', prenom: user.prenom || '', fonction: user.fonction || '' }); setPaiement({ titulaire_compte: user.titulaire_compte || '', nom_banque: user.nom_banque || '', iban: user.iban || '', bic: user.bic || '', mode_paiement: user.mode_paiement || 'virement' }); } catch (err) { setError('Erreur lors du chargement du profil'); console.error('Erreur:', err); } finally { setLoading(false); } };

  const handleEntrepriseChange = (e) => { const { name, value } = e.target; setEntreprise(prev => ({ ...prev, [name]: value })); };
  const handlePaiementChange = (e) => { const { name, value } = e.target; setPaiement(prev => ({ ...prev, [name]: value })); };

  const handleSaveEntreprise = async () => { try { setLoading(true); await authApi.updateEntrepriseProfile(entreprise); setMessage('\u2705 Informations de l\'entreprise enregistrees avec succes.'); setTimeout(() => setMessage(''), 3000); } catch (err) { setError('Erreur lors de l\'enregistrement des informations'); console.error('Erreur:', err); } finally { setLoading(false); } };

  const handleSavePaiement = async () => { try { setLoading(true); await authApi.updateEntrepriseProfile(paiement); setMessage('\u2705 Informations de paiement enregistrees avec succes.'); setTimeout(() => setMessage(''), 3000); } catch (err) { setError('Erreur lors de l\'enregistrement des informations de paiement'); console.error('Erreur:', err); } finally { setLoading(false); } };

  if (loading) return (<div className="flex justify-center items-center h-64"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div></div>);

  return (
    <div className="flex min-h-screen bg-gray-50">
      <div className="w-1/4 bg-gradient-to-r from-blue-700 via-blue-600 to-blue-700 border-r"><ul className="p-4 space-y-2 text-white"><li onClick={() => setActiveTab('informations')} className={`cursor-pointer px-4 py-2 rounded ${activeTab === 'informations' ? 'bg-gradient-to-r from-orange-400 to-orange-600 text-white font-semibold' : 'hover:bg-gradient-to-r from-orange-400 to-orange-600'}`}>Informations societe</li><li onClick={() => setActiveTab('paiement')} className={`cursor-pointer px-4 py-2 rounded ${activeTab === 'paiement' ? 'bg-gradient-to-r from-orange-400 to-orange-600 text-white font-semibold' : 'hover:bg-gradient-to-r from-orange-400 to-orange-600'}`}>Moyens de paiement</li><li onClick={() => setActiveTab('factures')} className={`cursor-pointer px-4 py-2 rounded ${activeTab === 'factures' ? 'bg-gradient-to-r from-orange-400 to-orange-600 text-white font-semibold' : 'hover:bg-gradient-to-r from-orange-400 to-orange-600'}`}>Factures</li></ul></div>
      <div className="w-3/4 p-8 bg-gradient-to-r from-blue-700 via-blue-500 to-orange-500">
        {activeTab === 'informations' && (<div className="max-w-4xl"><h2 className="text-xl font-semibold mb-6 text-white">Informations de l'entreprise</h2><form className="space-y-6"><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label className="block text-sm font-medium text-white">Nom de l'entreprise</label><input type="text" name="nom_entreprise" value={entreprise.nom_entreprise} onChange={handleEntrepriseChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div><div><label className="block text-sm font-medium text-white">SIRET</label><input type="text" name="siret" value={entreprise.siret} onChange={handleEntrepriseChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div><div><label className="block text-sm font-medium text-white">Adresse</label><input type="text" name="adresse" value={entreprise.adresse} onChange={handleEntrepriseChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div><div><label className="block text-sm font-medium text-white">Code postal</label><input type="text" name="code_postal" value={entreprise.code_postal} onChange={handleEntrepriseChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div><div><label className="block text-sm font-medium text-white">Ville</label><input type="text" name="ville" value={entreprise.ville} onChange={handleEntrepriseChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div><div><label className="block text-sm font-medium text-white">Pays</label><input type="text" name="pays" value={entreprise.pays} onChange={handleEntrepriseChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div><div><label className="block text-sm font-medium text-white">E-mail</label><input type="email" name="email" value={entreprise.email} onChange={handleEntrepriseChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div><div><label className="block text-sm font-medium text-white">Telephone</label><input type="tel" name="telephone" value={entreprise.telephone} onChange={handleEntrepriseChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div><div className="md:col-span-2"><label className="block text-sm font-medium text-white">Nom du responsable</label><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" name="prenom" placeholder="Prenom" value={entreprise.prenom} onChange={handleEntrepriseChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /><input type="text" name="nom" placeholder="Nom" value={entreprise.nom} onChange={handleEntrepriseChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div></div><div className="md:col-span-2"><label className="block text-sm font-medium text-white">Fonction</label><input type="text" name="fonction" value={entreprise.fonction} onChange={handleEntrepriseChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div></div><div><label className="block text-sm font-medium text-white">Description</label><textarea name="description" value={entreprise.description} onChange={handleEntrepriseChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg h-24" /></div><div className="flex gap-4"><button type="button" className="px-4 py-2 bg-gradient-to-r from-blue-400 to-blue-600 text-white rounded hover:from-blue-300 hover:to-blue-500 transition-all duration-300 whitespace-nowrap disabled:opacity-50" onClick={loadProfile}>Annuler</button><button type="button" onClick={handleSaveEntreprise} disabled={loading} className="px-4 py-2 bg-gradient-to-r from-orange-400 to-orange-600 text-white rounded hover:from-orange-300 hover:to-blue-500 transition-all duration-300 whitespace-nowrap disabled:opacity-50">{loading ? 'Enregistrement...' : 'Enregistrer'}</button></div>{message && <p className="text-green-600 mt-2 text-sm">{message}</p>}{error && <p className="text-red-600 mt-2 text-sm">{error}</p>}</form></div>)}
        {activeTab === 'paiement' && (<div className="max-w-xl"><h2 className="text-xl font-semibold mb-6 text-white">Moyens de paiement</h2><form className="space-y-5"><div><label className="block text-sm font-medium text-white">Titulaire du compte</label><input type="text" name="titulaire_compte" value={paiement.titulaire_compte} onChange={handlePaiementChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nom du titulaire du compte" /></div><div><label className="block text-sm font-medium text-white">Nom de la banque</label><input type="text" name="nom_banque" value={paiement.nom_banque} onChange={handlePaiementChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nom de la banque" /></div><div><label className="block text-sm font-medium text-white">IBAN</label><input type="text" name="iban" value={paiement.iban} onChange={handlePaiementChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="FR76 3000 6000 0112 3456 7890 189" /></div><div><label className="block text-sm font-medium text-white">BIC / SWIFT</label><input type="text" name="bic" value={paiement.bic} onChange={handlePaiementChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="AGRIFRPP" /></div><div><label className="block text-sm font-medium text-white">Mode de paiement prefere</label><select name="mode_paiement" value={paiement.mode_paiement} onChange={handlePaiementChange} className="w-full px-3 py-2 border border-gray-300 rounded-lg"><option value="virement">Virement bancaire</option><option value="carte">Carte bancaire</option><option value="paypal">PayPal</option></select></div><div className="flex gap-4"><button type="button" className="px-4 py-2 bg-gradient-to-r from-blue-400 to-blue-600 text-white rounded hover:from-blue-300 hover:to-blue-500 transition-all duration-300 whitespace-nowrap disabled:opacity-50" onClick={loadProfile}>Annuler</button><button type="button" onClick={handleSavePaiement} disabled={loading} className="px-4 py-2 bg-gradient-to-r from-orange-400 to-orange-600 text-white rounded hover:from-orange-300 hover:to-blue-500 transition-all duration-300 whitespace-nowrap disabled:opacity-50">{loading ? 'Enregistrement...' : 'Enregistrer'}</button></div>{message && <p className="text-green-600 mt-2 text-sm">{message}</p>}{error && <p className="text-red-600 mt-2 text-sm">{error}</p>}</form></div>)}
        {activeTab === 'factures' && (<div className="max-w-4xl"><h2 className="text-xl font-semibold mb-6 text-white">Historique des factures</h2><div className="bg-white shadow-sm border rounded"><div className="p-4 bg-gray-50 border-b"><p className="text-gray-600">Cette section sera implementee dans une prochaine version.</p></div></div></div>)}
      </div>
    </div>
  );
};

export default ParametresEntreprise;
